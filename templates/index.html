<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>节点和请求者监控</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.0/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }
        .chart {
            width: 95vw;
            height: calc(50vh - 50px);  /* 减去padding和标题的高度 */
            margin: 10px auto;
        }
        h2 {
            text-align: center;
            color: #333;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h2>带宽使用情况</h2>
    <div id="bandwidth-chart" class="chart"></div>

    <h2>成本情况</h2>
    <div id="cost-chart" class="chart"></div>

    <!-- 第一个Modal - 输入计费信息 -->
    <div class="modal fade" id="pricingModal" tabindex="-1" aria-labelledby="pricingModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pricingModalLabel">请输入计费信息</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 输入五个单价参数 -->
                    <div class="mb-3">
                        <label for="monthly-price" class="form-label">月95单价:</label>
                        <input type="text" class="form-control" id="monthly-price" value="1">
                    </div>
                    <div class="mb-3">
                        <label for="daily-price" class="form-label">日95单价:</label>
                        <input type="text" class="form-control" id="daily-price" value="1">
                    </div>
                    <div class="mb-3">
                        <label for="peak-price" class="form-label">晚高峰95单价:</label>
                        <input type="text" class="form-control" id="peak-price" value="1">
                    </div>
                    <div class="mb-3">
                        <label for="buyout-price" class="form-label">买断总价:</label>
                        <input type="text" class="form-control" id="buyout-price" value="200">
                    </div>
                    <div class="mb-3">
                        <label for="avg-daily-price" class="form-label">日峰值月平均单价:</label>
                        <input type="text" class="form-control" id="avg-daily-price" value="1">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" onclick="submitPricingData()" data-bs-dismiss="modal">确认计费信息</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 第二个Modal - 输入带宽总量和请求总量 -->
    <div class="modal fade" id="bandwidthModal" tabindex="-1" aria-labelledby="bandwidthModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bandwidthModalLabel">请输入带宽总量和请求总量</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="bandwidth-total" class="form-label">带宽总量 :</label>
                        <input type="text" class="form-control" id="bandwidth-total" value="10000">
                    </div>
                    <div class="mb-3">
                        <label for="requests-total" class="form-label">请求总量 :</label>
                        <input type="number" class="form-control" id="requests-total" value="10000">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" onclick="submitBandwidthData()" data-bs-dismiss="modal">确认带宽数据</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let bandwidthChart;
        let costChart;
        let bandwidthSelected = {};
        let costSelected = {};

        let pricingData = {};
        let bandwidthData = {};

        // 初始化图表
        function initCharts() {
            bandwidthChart = echarts.init(document.getElementById('bandwidth-chart'));
            costChart = echarts.init(document.getElementById('cost-chart'));

            bandwidthChart.on('legendselectchanged', function(params) {
                bandwidthSelected = params.selected;
            });

            costChart.on('legendselectchanged', function(params) {
                costSelected = params.selected;
            });

            updateCharts();
        }

        function updateCharts() {
            fetch('/data')
                .then(response => response.json())
                .then(data => {
                    const bandwidthSeries = [];
                    const costSeries = [];

                    // 添加总带宽曲线
                    bandwidthSeries.push({
                        name: 'Total Bandwidth',
                        type: 'line',
                        data: data.total_bandwidth,
                        smooth: true,
                        lineStyle: { width: 3, type: 'solid' },
                        symbol: 'none',
                        itemStyle: { color: '#ff0000' }
                    });

                    // 添加节点数据
                    for (let i = 0; i < 10; i++) {
                        bandwidthSeries.push({
                            name: `Node ${i}`,
                            type: 'line',
                            data: data.nodes.bandwidths[i],
                            smooth: true,
                            lineStyle: { width: 2 },
                            symbol: 'none',
                            selected: false  // 默认隐藏
                        });
                        costSeries.push({
                            name: `Node ${i}`,
                            type: 'line',
                            data: data.nodes.costs[i],
                            smooth: true,
                            lineStyle: { width: 2 },
                            symbol: 'none',
                            selected: false  // 默认隐藏
                        });
                    }

                    // 添加请求者数据
                    for (let i = 0; i < 5; i++) {
                        bandwidthSeries.push({
                            name: `Requester ${i}`,
                            type: 'line',
                            data: data.requesters.bandwidths[i],
                            smooth: true,
                            lineStyle: { width: 2 },
                            symbol: 'none',
                            selected: false  // 默认隐藏
                        });
                        costSeries.push({
                            name: `Requester ${i}`,
                            type: 'line',
                            data: data.requesters.costs[i],
                            smooth: true,
                            lineStyle: { width: 2 },
                            symbol: 'none',
                            selected: false  // 默认隐藏
                        });
                    }

                    // 添加总成本曲线
                    costSeries.push({
                        name: 'Total Cost',
                        type: 'line',
                        data: data.total_cost,
                        smooth: true,
                        lineStyle: { width: 3, type: 'solid' },
                        symbol: 'none',
                        itemStyle: { color: '#ff0000' }
                    });

                    const option = {
                        tooltip: {
                            trigger: 'axis',
                            formatter: function(params) {
                                const timestamp = data.start_timestamp + params[0].axisValue * 300;  // 实际时间戳
                                const totalDays = Math.floor(timestamp / 86400);  // 总天数
                                const totalHours = Math.floor((timestamp % 86400) / 3600);  // 当天小时数
                                const totalMinutes = Math.floor((timestamp % 3600) / 60);  // 当前小时分钟数
                                let result = `第${totalDays}天 ${totalHours}时${totalMinutes}分<br/>`;
                                params.forEach(param => {
                                    result += `${param.seriesName}: ${param.value.toFixed(2)}<br/>`;
                                });
                                return result;
                            }
                        },
                        legend: {
                            data: ['Total Bandwidth']
                                .concat([...Array(10).keys()].map(i => `Node ${i}`))
                                .concat([...Array(5).keys()].map(i => `Requester ${i}`)),
                            type: 'scroll',
                            orient: 'vertical',
                            right: '1%',  // 右侧显示
                            top: 20,
                            bottom: 20,
                            selected: Object.keys(bandwidthSelected).length > 0 ? bandwidthSelected : Object.fromEntries([...Array(10).keys()].map(i => [`Node ${i}`, false]).concat([...Array(5).keys()].map(i => [`Requester ${i}`, false]))),
                        },
                        grid: { left: '3%', right: '10%', bottom: '5%', top: '15%', containLabel: true },
                        xAxis: {
                            type: 'category',
                            data: [...Array(data.timestamps.length).keys()],
                            name: '时间',
                            axisLabel: {
                                formatter: function(value) {
                                    const timestamp = data.start_timestamp + value * 300;
                                    const days = Math.floor(timestamp / 86400);
                                    return `${days}d`;
                                },
                                interval: 288  // 每天显示一个刻度
                            }
                        },
                        yAxis: { type: 'value', name: '带宽 (MB/s)', splitLine: { show: true, lineStyle: { type: 'dashed' } } },
                        series: bandwidthSeries,
                        animation: false
                    };

                    const costOption = {
                        ...option,
                        legend: {
                            data: ['Total Cost'].concat([...Array(10).keys()].map(i => `Node ${i}`)).concat([...Array(5).keys()].map(i => `Requester ${i}`)),
                            orient: 'vertical',
                            right: '1%',  // 右侧显示
                            selected: Object.keys(costSelected).length > 0 ? costSelected : Object.fromEntries([...Array(10).keys()].map(i => [`Node ${i}`, false]).concat([...Array(5).keys()].map(i => [`Requester ${i}`, false]))),
                        },
                        yAxis: { type: 'value', name: '成本', splitLine: { show: true, lineStyle: { type: 'dashed' } } },
                        series: costSeries
                    }
                    // 更新图表
                    bandwidthChart.setOption(option);
                    costChart.setOption(costOption);
                });
        }


        {#// 更新图表数据#}
        {#function updateCharts() {#}
        {#    fetch('/data')#}
        {#        .then(response => response.json())#}
        {#        .then(data => {#}
        {#            const bandwidthSeries = [];#}
        {#            const costSeries = [];#}
        {##}
        {#            // 添加总带宽曲线#}
        {#            bandwidthSeries.push({#}
        {#                name: 'Total Bandwidth',#}
        {#                type: 'line',#}
        {#                data: data.total_bandwidth,#}
        {#                smooth: true,#}
        {#                lineStyle: { width: 3, type: 'solid' },#}
        {#                symbol: 'none',#}
        {#                itemStyle: { color: '#ff0000' }#}
        {#            });#}
        {##}
        {#            // 添加节点数据#}
        {#            for (let i = 0; i < 10; i++) {#}
        {#                bandwidthSeries.push({#}
        {#                    name: `Node ${i}`,#}
        {#                    type: 'line',#}
        {#                    data: data.nodes.bandwidths[i],#}
        {#                    smooth: true,#}
        {#                    lineStyle: { width: 2 },#}
        {#                    symbol: 'none',#}
        {#                    selected: false  // 默认隐藏#}
        {#                });#}
        {#                costSeries.push({#}
        {#                    name: `Node ${i}`,#}
        {#                    type: 'line',#}
        {#                    data: data.nodes.costs[i],#}
        {#                    smooth: true,#}
        {#                    lineStyle: { width: 2 },#}
        {#                    symbol: 'none',#}
        {#                    selected: false  // 默认隐藏#}
        {#                });#}
        {#            }#}
        {##}
        {#            // 添加请求者数据#}
        {#            for (let i = 0; i < 5; i++) {#}
        {#                bandwidthSeries.push({#}
        {#                    name: `Requester ${i}`,#}
        {#                    type: 'line',#}
        {#                    data: data.requesters.bandwidths[i],#}
        {#                    smooth: true,#}
        {#                    lineStyle: { width: 2 },#}
        {#                    symbol: 'none',#}
        {#                    selected: false  // 默认隐藏#}
        {#                });#}
        {#                costSeries.push({#}
        {#                    name: `Requester ${i}`,#}
        {#                    type: 'line',#}
        {#                    data: data.requesters.costs[i],#}
        {#                    smooth: true,#}
        {#                    lineStyle: { width: 2 },#}
        {#                    symbol: 'none',#}
        {#                    selected: false  // 默认隐藏#}
        {#                });#}
        {#            }#}
        {##}
        {#            // 添加总成本曲线#}
        {#            costSeries.push({#}
        {#                name: 'Total Cost',#}
        {#                type: 'line',#}
        {#                data: data.total_cost,#}
        {#                smooth: true,#}
        {#                lineStyle: { width: 3, type: 'solid' },#}
        {#                symbol: 'none',#}
        {#                itemStyle: { color: '#ff0000' }#}
        {#            });#}
        {##}
        {#            const option = {#}
        {#                tooltip: {#}
        {#                    trigger: 'axis',#}
        {#                    formatter: function(params) {#}
        {#                        const timestamp = data.start_timestamp + params[0].axisValue * 300;  // 实际时间戳#}
        {#                        const totalDays = Math.floor(timestamp / 86400);  // 总天数#}
        {#                        const totalHours = Math.floor((timestamp % 86400) / 3600);  // 当天小时数#}
        {#                        const totalMinutes = Math.floor((timestamp % 3600) / 60);  // 当前小时分钟数#}
        {#                        let result = `第${totalDays}天 ${totalHours}时${totalMinutes}分<br/>`;#}
        {#                        params.forEach(param => {#}
        {#                            result += `${param.seriesName}: ${param.value.toFixed(2)}<br/>`;#}
        {#                        });#}
        {#                        return result;#}
        {#                    }#}
        {#                },#}
        {#                legend: {#}
        {#                    data: ['Total Bandwidth']#}
        {#                        .concat([...Array(10).keys()].map(i => `Node ${i}`))#}
        {#                        .concat([...Array(5).keys()].map(i => `Requester ${i}`)),#}
        {#                    type: 'scroll',#}
        {#                    orient: 'vertical',#}
        {#                    right: '1%',#}
        {#                    top: 20,#}
        {#                    bottom: 20,#}
        {#                    selected: Object.keys(bandwidthSelected).length > 0 ? bandwidthSelected : Object.fromEntries([...Array(10).keys()].map(i => [`Node ${i}`, false]).concat([...Array(5).keys()].map(i => [`Requester ${i}`, false]))),#}
        {#                },#}
        {#                grid: { left: '3%', right: '10%', bottom: '5%', top: '15%', containLabel: true },#}
        {#                xAxis: {#}
        {#                    type: 'category',#}
        {#                    data: [...Array(data.timestamps.length).keys()],#}
        {#                    name: '时间',#}
        {#                    axisLabel: {#}
        {#                        formatter: function(value) {#}
        {#                            const timestamp = data.start_timestamp + value * 300;#}
        {#                            const days = Math.floor(timestamp / 86400);#}
        {#                            return `${days}d`;#}
        {#                        },#}
        {#                        interval: 288  // 每天显示一个刻度#}
        {#                    }#}
        {#                },#}
        {#                yAxis: { type: 'value', name: '带宽 (MB/s)', splitLine: { show: true, lineStyle: { type: 'dashed' } } },#}
        {#                series: bandwidthSeries,#}
        {#                animation: false#}
        {#            };#}
        {##}
        {#            const costOption = { ...option, legend: { data: ['Total Cost'].concat([...Array(10).keys()].map(i => `Node ${i}`)).concat([...Array(5).keys()].map(i => `Requester ${i}`)) }, yAxis: { type: 'value', name: '成本', splitLine: { show: true, lineStyle: { type: 'dashed' } } }, series: costSeries };#}
        {##}
        {#            bandwidthChart.setOption(option);#}
        {#            costChart.setOption(costOption);#}
        {#        });#{#}

        // 提交计费数据
        function submitPricingData() {
            // 获取计费数据并验证
            const monthlyPrice = parseFloat(document.getElementById('monthly-price').value);
            const dailyPrice = parseFloat(document.getElementById('daily-price').value);
            const peakPrice = parseFloat(document.getElementById('peak-price').value);
            const buyoutPrice = parseFloat(document.getElementById('buyout-price').value);
            const avgDailyPrice = parseFloat(document.getElementById('avg-daily-price').value);

            // 检查是否为有效数字，并且小数点后不超过三位
            if (![monthlyPrice, dailyPrice, peakPrice, buyoutPrice, avgDailyPrice].every(isValidPrice)) {
                alert("所有参数必须是有效数字，并且小数点后不能超过两位");
                return;
            }

            pricingData = { unit_price: [monthlyPrice, dailyPrice, peakPrice, buyoutPrice, avgDailyPrice] };

            // 关闭计费信息模态框，显示带宽数据输入框
            // 获取模态框对象
            const pricingModalElement = document.getElementById('pricingModal');
            const pricingModal = new bootstrap.Modal(pricingModalElement);

            // 检查模态框对象
            console.log(pricingModalElement); // 输出检查是否正确

            pricingModal.hide(); // 确保隐藏模态框

            const bandwidthModal = new bootstrap.Modal(document.getElementById('bandwidthModal'));
            bandwidthModal.show();
        }

        // 提交带宽数据
        function submitBandwidthData() {
            // 获取带宽数据并验证
            const bandwidthTotal = parseFloat(document.getElementById('bandwidth-total').value);
            const requestsTotal = parseInt(document.getElementById('requests-total').value);

            if (isNaN(bandwidthTotal) || isNaN(requestsTotal) || requestsTotal <= 0 || bandwidthTotal <= 0) {
                alert("带宽总量必须为正数，且请求总量必须为正整数");
                return;
            }

            bandwidthData = { bandwidth_num: bandwidthTotal, url_num: requestsTotal };

            // 提交所有数据
            const finalData = {
                ...pricingData,
                ...bandwidthData
            };

            fetch('/update_params', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(finalData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    console.log('Parameters updated:', data);
                    // 关闭带宽数据模态框
                    const bandwidthModal = new bootstrap.Modal(document.getElementById('bandwidthModal'));
                    bandwidthModal.hide();
                } else {
                    alert('参数传递失败：' + data.message);
                }
            });
        }

        // 验证输入的价格是否为有效数字，且小数点后不超过三位
        function isValidPrice(value) {
            // 匹配正整数或者最多两位小数的数字
            const regex = /^\d+(\.\d{1,2})?$/;
            return regex.test(value);
        }

        window.addEventListener('load', function() {
            initCharts();
            // 显示第一个模态框
            var pricingModal = new bootstrap.Modal(document.getElementById('pricingModal'));
            pricingModal.show();
        });

        window.addEventListener('resize', () => {
            bandwidthChart && bandwidthChart.resize();
            costChart && costChart.resize();
        });

        // 每秒更新一次数据
        setInterval(updateCharts, 1000);
    </script>
</body>
</html>
